# Monorepo 组件库项目创建步骤文档

## 一、项目初始化

### 1.1 创建 Monorepo 项目结构

```bash
# 创建项目根目录
mkdir backstage-form-monorepo
cd backstage-form-monorepo

# 初始化根目录 package.json
npm init -y

# 创建 packages 目录结构
mkdir -p packages/ui-components
mkdir -p packages/app-spa
mkdir -p packages/docs
```

### 1.2 选择 Monorepo 管理工具

#### 方案 A: 使用 Lerna

```bash
# 安装 Lerna
npm install -D lerna

# 初始化 Lerna
npx lerna init

# 修改 lerna.json 配置
```

#### 方案 B: 使用 Nx

```bash
# 安装 Nx
npx create-nx-workspace@latest backstage-form-monorepo --preset=npm

# 或使用 Nx CLI
npm install -D nx @nrwl/workspace
```

### 1.3 配置根目录 package.json

```json
{
  "name": "backstage-form-monorepo",
  "version": "1.0.0",
  "private": true,
  "workspaces": [
    "packages/*"
  ],
  "scripts": {
    "bootstrap": "lerna bootstrap",
    "build": "lerna run build",
    "dev": "lerna run dev --parallel",
    "lint": "lerna run lint",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "prepare": "husky install"
  },
  "devDependencies": {
    "@commitlint/cli": "^17.0.0",
    "@commitlint/config-conventional": "^17.0.0",
    "@typescript-eslint/eslint-plugin": "^5.0.0",
    "@typescript-eslint/parser": "^5.0.0",
    "eslint": "^8.0.0",
    "eslint-config-prettier": "^8.0.0",
    "eslint-plugin-react": "^7.0.0",
    "eslint-plugin-react-hooks": "^4.0.0",
    "husky": "^8.0.0",
    "lerna": "^6.0.0",
    "prettier": "^2.0.0",
    "typescript": "^5.0.0"
  }
}
```

---

## 二、组件库配置 (packages/ui-components)

### 2.1 初始化组件库项目

```bash
cd packages/ui-components
npm init -y
```

### 2.2 安装依赖

```bash
# 生产依赖（外部化，不打包）
npm install react react-dom antd

# 开发依赖
npm install -D @types/react @types/react-dom
npm install -D webpack webpack-cli webpack-dev-server
npm install -D html-webpack-plugin
npm install -D ts-loader css-loader style-loader
npm install -D @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript
npm install -D babel-loader
```

### 2.3 配置 TypeScript

创建 `tsconfig.json`:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react-jsx",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": false
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### 2.4 配置 Webpack（每个组件独立打包）

创建 `webpack.config.ts`:

```typescript
import path from 'path';
import { Configuration } from 'webpack';
import HtmlWebpackPlugin from 'html-webpack-plugin';

// 获取所有组件名称（从 src/components 目录读取）
const fs = require('fs');
const componentsDir = path.resolve(__dirname, 'src/components');
const components = fs.readdirSync(componentsDir).filter((dir: string) => {
  return fs.statSync(path.join(componentsDir, dir)).isDirectory();
});

// 为每个组件生成配置
const componentConfigs: Configuration[] = components.map((componentName: string) => {
  const baseConfig: Configuration = {
    mode: process.env.NODE_ENV === 'production' ? 'production' : 'development',
    entry: `./src/components/${componentName}/pages/index.tsx`,
    externals: {
      'react': {
        commonjs: 'react',
        commonjs2: 'react',
        amd: 'react',
        root: 'React'
      },
      'react-dom': {
        commonjs: 'react-dom',
        commonjs2: 'react-dom',
        amd: 'react-dom',
        root: 'ReactDOM'
      },
      'antd': {
        commonjs: 'antd',
        commonjs2: 'antd',
        amd: 'antd',
        root: 'antd'
      }
    },
    resolve: {
      extensions: ['.ts', '.tsx', '.js', '.jsx']
    },
    module: {
      rules: [
        {
          test: /\.tsx?$/,
          use: 'ts-loader',
          exclude: /node_modules/
        },
        {
          test: /\.css$/,
          use: ['style-loader', 'css-loader']
        }
      ]
    },
    plugins: []
  };

  // UMD 配置
  const umdConfig: Configuration = {
    ...baseConfig,
    output: {
      path: path.resolve(__dirname, `dist/${componentName}/umd`),
      filename: 'index.js',
      library: {
        name: componentName,
        type: 'umd',
        export: 'default'
      },
      globalObject: 'this'
    }
  };

  // ESM 配置
  const esmConfig: Configuration = {
    ...baseConfig,
    output: {
      path: path.resolve(__dirname, `dist/${componentName}/esm`),
      filename: 'index.js',
      library: {
        type: 'module'
      }
    },
    experiments: {
      outputModule: true
    }
  };

  return [umdConfig, esmConfig];
}).flat();

export default componentConfigs;
```

### 2.5 配置 package.json

```json
{
  "name": "@backstage/ui-components",
  "version": "1.0.0",
  "main": "dist/index.js",
  "module": "dist/index.esm.js",
  "types": "dist/index.d.ts",
  "files": [
    "dist",
    "src"
  ],
  "scripts": {
    "build": "webpack --mode production",
    "dev": "webpack serve --mode development",
    "lint": "eslint src --ext .ts,.tsx",
    "type-check": "tsc --noEmit"
  },
  "peerDependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "antd": "^5.0.0"
  }
}
```

### 2.6 创建组件目录结构

以 `UserProfileForm` 组件为例：

```bash
mkdir -p src/components/UserProfileForm/{pages,config,i18n,data,utils}
```

创建文件：

- `src/components/UserProfileForm/index.ts` - 统一导出
- `src/components/UserProfileForm/pages/index.tsx` - 表单主逻辑
- `src/components/UserProfileForm/config/index.ts` - 组件元信息
- `src/components/UserProfileForm/i18n/index.ts` - 多语言入口
- `src/components/UserProfileForm/i18n/zh.ts` - 中文
- `src/components/UserProfileForm/i18n/en.ts` - 英文
- `src/components/UserProfileForm/data/index.ts` - 静态数据
- `src/components/UserProfileForm/utils/index.ts` - 工具函数（可选）
- `src/components/UserProfileForm/README.md` - 产品文档
- `src/components/UserProfileForm/CODE_TEMPLATE.md` - 代码范式

### 2.7 组件示例代码

#### `src/components/UserProfileForm/index.ts`

```typescript
export * from './pages';
export * from './config';
```

#### `src/components/UserProfileForm/pages/index.tsx`

```typescript
import React from 'react';
import { Form, Input, Button } from 'antd';
import { config } from '../config';
import { i18n } from '../i18n';

const UserProfileForm: React.FC = () => {
  const [form] = Form.useForm();

  const handleSubmit = (values: any) => {
    console.log('Form values:', values);
  };

  return (
    <Form form={form} onFinish={handleSubmit} layout="vertical">
      <Form.Item
        name="username"
        label={i18n.username}
        rules={[{ required: true, message: i18n.usernameRequired }]}
      >
        <Input />
      </Form.Item>
      <Form.Item>
        <Button type="primary" htmlType="submit">
          {i18n.submit}
        </Button>
      </Form.Item>
    </Form>
  );
};

export default UserProfileForm;
```

#### `src/components/UserProfileForm/config/index.ts`

```typescript
export const config = {
  name: 'UserProfileForm',
  version: '1.0.0',
  description: '用户资料表单组件',
  author: 'Your Name'
};
```

#### `src/components/UserProfileForm/i18n/index.ts`

```typescript
import { zh } from './zh';
import { en } from './en';

const locale = 'zh'; // 可以从外部传入

export const i18n = locale === 'zh' ? zh : en;
```

#### `src/components/UserProfileForm/i18n/zh.ts`

```typescript
export const zh = {
  username: '用户名',
  usernameRequired: '请输入用户名',
  submit: '提交'
};
```

#### `src/components/UserProfileForm/i18n/en.ts`

```typescript
export const en = {
  username: 'Username',
  usernameRequired: 'Please enter username',
  submit: 'Submit'
};
```

---

## 三、SPA 调试应用配置 (packages/app-spa)

### 3.1 初始化 SPA 项目

```bash
cd packages/app-spa
npm init -y
```

### 3.2 安装依赖

```bash
npm install react react-dom antd
npm install -D @types/react @types/react-dom
npm install -D webpack webpack-cli webpack-dev-server
npm install -D html-webpack-plugin
npm install -D ts-loader css-loader style-loader
npm install -D @babel/core @babel/preset-env @babel/preset-react @babel/preset-typescript
npm install -D babel-loader
```

### 3.3 创建 UMD 加载测试页面

创建 `public/umd-test.html`:

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMD 组件测试</title>
  <!-- 引入 React 和 Antd -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/antd@5/dist/reset.css">
  <script src="https://unpkg.com/antd@5/dist/antd.min.js"></script>
  
  <style>
    body {
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .component-selector {
      margin-bottom: 20px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
    }
    .component-selector select {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="component-selector">
    <label>选择组件: </label>
    <select id="componentSelect">
      <option value="UserProfileForm">UserProfileForm</option>
      <!-- 可以动态添加更多组件 -->
    </select>
  </div>
  
  <div id="root"></div>

  <script>
    // 组件配置
    const COMPONENT_BASE_URL = 'http://localhost:3001'; // 组件库服务地址
    const currentComponent = {
      name: 'UserProfileForm',
      script: null
    };

    // 加载组件脚本
    function loadComponent(componentName) {
      // 移除旧的脚本
      if (currentComponent.script) {
        document.body.removeChild(currentComponent.script);
      }

      // 创建新的脚本标